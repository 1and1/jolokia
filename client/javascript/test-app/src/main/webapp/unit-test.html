<!--
  ~ Copyright 2009-2010 Roland Huss
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<!-- Jolokia Javascript Client Lib Unit test -->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <title>Jolokia Javascript Testsuite</title>
  <script type="text/javascript" src="scripts/jquery-1.4.4.js"></script>
  <script type="text/javascript" src="scripts/qunit.js"></script>
  <script type="text/javascript" src="scripts/lib/jolokia.js"></script>
  <script type="text/javascript" src="scripts/lib/json2.js"></script>

  <link rel="stylesheet" href="css/qunit.css" type="text/css" media="screen" />
  <script>
  $(document).ready(function(){

    var j4p = new Jolokia({url: "http://localhost:8080/jolokia"});

    singleRequestTest("GET-Requests", { method: "GET" });
    singleRequestTest("POST-Requests", { method: "POST" });
    singleRequestTest("GET-Requests with jsonp", { jsonp: true });

    errorTest("GET-Requests", { method: "GET", jsonp: false });
    // ==========================================================================================

    // Single Request Tests
    function singleRequestTest(label,extraParams) {
      module("Async: " + label);
      asyncTest("Simple Memory Read Request",function() {
        j4p.request(
        { type: "READ", mbean: "java.lang:type=Memory", attribute: "HeapMemoryUsage"},
        $.extend(extraParams,
                {
                  success: function(response) {
                    equals(response.request.type,"read","Type must be read");
                    ok(response.value != null,"Value must be set: " + JSON.stringify(response.value));
                    ok(response.value.used != null,"Composite data returned: " );
                    start();
                  }
                })
                );
      });
      asyncTest("Simple Memory Read Request with path",function() {
        j4p.request(
        { type: "READ", mbean: "java.lang:type=Memory", attribute: "HeapMemoryUsage", path: "used" },
        $.extend(extraParams,
                {
                  success: function(response) {
                    equals(response.request.type,"read","Type must be read");
                    ok(response.value != null,"Value must be set: " + response.value);
                    ok(response.value.used == null,"No complex structure");
                    start();
                  }
                })
        );
      });
      asyncTest("Exec Request: garbage collection",function() {
        j4p.request(
        { type: "exec", mbean: "java.lang:type=Memory", operation: "gc"},
        $.extend(extraParams,
                {
                  success: function(response) {
                    equals(response.request.type,"exec","Type must be exec");
                    ok(response.value == null,"Return Value is null ");
                    console.log(JSON.stringify(response));
                    start();
                  }
                }));
      });
      asyncTest("Version Request",function() {
        j4p.request(
        { type: "version" },
        $.extend(extraParams,
                {
                  success: function(response) {
                    equals(response.request.type,"version","Type must be version");
                    ok(response.value.protocol >= 4.0,"Protocol must be greater or equals 4.0");
                    ok(response.value.agent >= 0.81,"Agent version check");
                    start();
                  }
                }));
      });
    };

    function errorTest(label,extraParams) {
      module("Error-Test: " + label);
      asyncTest("Unknown MBean for 'read'",function() {
        j4p.request(
        { type: "read", mbean: "java.lang:name=bullshit"},
        $.extend(extraParams,
                {
                  error: function(response) {
                    log(response);
                    start();
                  },
                  success: function(response) {
                    log(response);
                    start();
                  },
                  ajaxError: function(response) {
                    log(response);
                    start();
                  }
                }));
      });
    }

    function log(response) {
      console.log(JSON.stringify(response));
    }
  });

  </script>
</head>

<body>
<h1 id="qunit-header">Jolokia QUnit Testsuite</h1>
<h2 id="qunit-banner"></h2>
<div id="qunit-testrunner-toolbar"></div>
<h2 id="qunit-userAgent"></h2>
<ol id="qunit-tests"></ol>
<div id="qunit-fixture">test markup, will be hidden</div>
</body>
</html>